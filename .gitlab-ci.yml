stages:
  - build
  - mirror
  - release

variables:
  EXTENSION_DIR: "src"

# Build extension on every push
build:
  stage: build
  image: alpine:latest
  before_script:
    - apk add --no-cache zip
  script:
    - cd $EXTENSION_DIR
    - zip -r ../better-auto-pip-$CI_COMMIT_SHORT_SHA.zip . -x "*.git*" -x "*.DS_Store" -x "node_modules/*"
  artifacts:
    paths:
      - better-auto-pip-$CI_COMMIT_SHORT_SHA.zip
    expire_in: 30 days
  only:
    - dev
    - main

# Mirror main branch to GitHub (excluding GitLab-specific files)
mirror-to-github:
  stage: mirror
  image: alpine:latest
  before_script:
    - apk add --no-cache git openssh-client rsync
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan github.com >> ~/.ssh/known_hosts
    - eval $(ssh-agent -s)
    # Add GitHub deploy key from GitLab CI/CD variable
    - echo "$GITHUB_DEPLOY_KEY" | tr -d '\r' | ssh-add -
  script:
    # Clone current repo to temp directory
    - git clone --branch main . /tmp/github-mirror
    - cd /tmp/github-mirror
    # Remove GitLab-specific files (add more exclusions here as needed)
    - rm -f .gitlab-ci.yml
    - rm -f setup-remotes.sh
    - rm -f GIT_SETUP.md
    # Commit the changes
    - git config user.name "GitLab CI"
    - git config user.email "ci@gitlab.com"
    - git add -A
    - git diff-index --quiet HEAD || git commit -m "Mirror from GitLab [skip ci]"
    # Push to GitHub
    - git remote add github git@github.com:seanharsh/Better-Auto-PiP.git || true
    - git push github main --force
  only:
    - main
  when: on_success

# Create release package on main push
release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache zip jq
  script:
    - cd $EXTENSION_DIR
    - VERSION=$(jq -r '.version' manifest.json)
    - zip -r ../better-auto-pip-v$VERSION.zip . -x "*.git*" -x "*.DS_Store" -x "node_modules/*"
    - echo "Created release package for version $VERSION"
  artifacts:
    paths:
      - better-auto-pip-v*.zip
    expire_in: never
  only:
    - main
