workflow:
  rules:
    - when: always

stages:
  - build
  - mirror
  - release

variables:
  EXTENSION_DIR: "src"

# Build extension on every push (works on both Linux and macOS)
build:
  stage: build
  before_script:
    # Install dependencies based on OS
    - |
      if [ -f /etc/alpine-release ]; then
        # Alpine Linux (Docker)
        apk add --no-cache zip
      elif [ "$(uname)" = "Darwin" ]; then
        # macOS
        which zip || echo "zip is required but already installed on macOS"
      else
        # Other Linux
        apt-get update && apt-get install -y zip || yum install -y zip || true
      fi
  script:
    - cd $EXTENSION_DIR
    - zip -r ../better-auto-pip-$CI_COMMIT_SHORT_SHA.zip . -x "*.git*" -x "*.DS_Store" -x "node_modules/*"
  artifacts:
    paths:
      - better-auto-pip-$CI_COMMIT_SHORT_SHA.zip
    expire_in: 30 days
  only:
    - dev
    - main

# Mirror main branch to GitHub using git-filter-repo
mirror-to-github:
  stage: mirror
  before_script:
    # Install dependencies based on OS
    - |
      if [ -f /etc/alpine-release ]; then
        # Alpine Linux (Docker)
        apk add --no-cache git python3 py3-pip openssh-client
      elif [ "$(uname)" = "Darwin" ]; then
        # macOS
        which git || echo "git required"
        which python3 || echo "python3 required"
        pip3 --version || python3 -m ensurepip
      else
        # Other Linux
        apt-get update && apt-get install -y git python3-pip openssh-client || yum install -y git python3-pip openssh-clients || true
      fi
    - pip3 install git-filter-repo
    - git config --global user.email "harshy@dersoldat.org"
    - git config --global user.name "SeanHarsh"
  script:
    # Ensure full history for filtering
    - git fetch --unshallow || git fetch --all --tags

    # Clone into a clean temp directory for filtering
    - rm -rf /tmp/filtered && git clone --no-tags --filter=blob:none . /tmp/filtered
    - cd /tmp/filtered
    - git checkout -B to-push "$CI_COMMIT_SHA"

    # Remove GitLab-specific and internal files from all history
    - git filter-repo --force --invert-paths --path .gitlab-ci.yml --path setup-remotes.sh --path GIT_SETUP.md --path TODO.md --path CHROME_WEB_STORE.md --path GITLAB_SSH_SETUP.md --path PERMISSIONS.md --path PUBLISHING.md --path .github/

    # Add remote and push to GitHub
    - git remote remove github 2>/dev/null || true
    - git remote add github https://oauth2:${GITHUB_TOKEN}@github.com/seanharsh/Better-Auto-PiP.git
    - git push github to-push:main --force
  only:
    - main
  when: on_success

# Create release package on main push (works on both Linux and macOS)
release:
  stage: release
  before_script:
    # Install dependencies based on OS
    - |
      if [ -f /etc/alpine-release ]; then
        # Alpine Linux (Docker)
        apk add --no-cache zip jq
      elif [ "$(uname)" = "Darwin" ]; then
        # macOS
        which zip || echo "zip is required but already installed on macOS"
        which jq || brew install jq
      else
        # Other Linux
        apt-get update && apt-get install -y zip jq || yum install -y zip jq || true
      fi
  script:
    - cd $EXTENSION_DIR
    - VERSION=$(jq -r '.version' manifest.json)
    - zip -r ../better-auto-pip-v$VERSION.zip . -x "*.git*" -x "*.DS_Store" -x "node_modules/*"
    - echo "Created release package for version $VERSION"
  artifacts:
    paths:
      - better-auto-pip-v*.zip
    expire_in: never
  only:
    - main